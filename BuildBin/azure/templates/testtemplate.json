
	"$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"adminUserName": {
			"type": "string",
			"defaultValue": "amarriott"
		},
		"sshKeyData": {
			"type": "string",
			"defaultValue": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPkYDabqeICj4havT7F/86zbmqTWr+iJU9DAWaYLZPVzMZRY2Kp8jn8VwbaxwIyVYb0n4AMlHXzacnkbo2hwNvQanSOIeReFprg7wthWdqtGmwaqG9t/Prxy3r+rjW0TuW1FLi0QdT2TOMuhBEY+Jh4UvyrtBqM8LXZIW1flj0LgV7sDwjtIy3nZq2sZjspDc2a52b7y9whc7QrFf8i0Pop3F08pEf/qubwZ+4mMCe0wwAxHQmVFAa+2OIZlMoMiCd7iFcn/psFc9e8dQ5J7LvBsJZbYfWN6gzMl+o8+jKhJXGVn1PesnhJu9k522lynmIwI2Ogg4udWR+LGOgj0Uf alexmarriott@ALEXs-MacBook-Pro.local"
		},
		"vmSize": {
			"type": "string",
			"defaultValue": "Standard_B1s"
		},
		"vmName": {
			"type": "string",
			"defaultValue": "R1TestNode"
		},
		"imagePublisher": {
			"type": "string",
			"defaultValue": "canonical"
		},
		"imageOffer": {
			"type": "string",
			"defaultValue": "ubuntuserver"
		},
		"imageSku": {
			"type": "string",
			"defaultValue": "18.04-LTS"
		},
		"imageVersion": {
			"type": "string",
			"defaultValue": "latest"
		},
		"subnetName": {
			"type": "string",
			"defaultValue": "Office1"
		},
		"virtualNetworkName": {
			"type": "string",
			"defaultValue": "TestNetwork"
		}
	},
	"variables": {
		"storageAccountName": "[concat(uniquestring(resourceGroup().id), 'testnetwork')]",
		"location": "[resourceGroup().location]",
		"osDiskName": "osDisk1",
		"vmStorageAccountContainerName": "[concat(parameters('vmName'), '-vhds')]",
		"nicName": "[concat(parameters('vmName'), '-NIC')]",
		"storageAccountType": "Standard_LRS",
		"networkSecurityGroupName": "[concat(parameters('vmName'), '-NSG')]",
		"sshKeyPath": "[concat('/home/',parameters('adminUsername'),'/.ssh/authorized_keys')]",
		"vnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
		"subnetRef": "[concat(variables('vnetID'),'/subnets/',parameters('subnetName'))]",
		"apiVersion": "2015-06-15"
	},
	"resources": [{
			"type": "Microsoft.Storage/storageAccounts",
			"name": "[variables('storageAccountName')]",
			"apiVersion": "[variables('apiVersion')]",
			"location": "[variables('location')]",
			"properties": {
				"accountType": "[variables('storageAccountType')]"
			}
		},
		{
			"apiVersion": "[variables('apiVersion')]",
			"type": "Microsoft.Network/networkSecurityGroups",
			"name": "[variables('networkSecurityGroupName')]",
			"location": "[variables('location')]",
			"properties": {
				"securityRules": [{
					"name": "ssh_rule",
					"properties": {
						"description": "Locks inbound down to ssh default port 22.",
						"protocol": "Tcp",
						"sourcePortRange": "*",
						"destinationPortRange": "22",
						"sourceAddressPrefix": "*",
						"destinationAddressPrefix": "*",
						"access": "Allow",
						"priority": 123,
						"direction": "Inbound"
					}
				}]
			}
		},
		{
			"apiVersion": "[variables('apiVersion')]",
			"type": "Microsoft.Network/virtualNetworks",
			"name": "[parameters('virtualNetworkName')]",
			"location": "[variables('location')]",
			"dependsOn": [
				"[concat('Microsoft.Network/networkSecurityGroups/', variables('networkSecurityGroupName'))]"
			],
			"properties": {
				"subnets": [{
					"name": "[parameters('subnetName')]",
					"properties": {
						"addressPrefix": "[variables('subnetPrefix')]",
						"networkSecurityGroup": {
							"id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
						}
					}
				}]
			}
		},
		{
			"apiVersion": "[variables('apiVersion')]",
			"type": "Microsoft.Network/networkInterfaces",
			"name": "[variables('nicName')]",
			"location": "[variables('location')]",
			"dependsOn": [
				"[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
			],
			"properties": {
				"ipConfigurations": [{
					"name": "ipconfig1",
					"properties": {
						"privateIPAllocationMethod": "Dynamic",
						"subnet": {
							"id": "[variables('subnetRef')]"
						}
					}
				}]
			}
		},
		{
			"apiVersion": "[variables('apiVersion')]",
			"type": "Microsoft.Compute/virtualMachines",
			"name": "[parameters('vmName')]",
			"location": "[variables('location')]",
			"dependsOn": [
				"[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]",
				"[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
			],
			"properties": {
				"hardwareProfile": {
					"vmSize": "[parameters('vmSize')]"
				},
				"osProfile": {
					"computerName": "[parameters('vmName')]",
					"adminUsername": "[parameters('adminUsername')]",
					"linuxConfiguration": {
						"disablePasswordAuthentication": "true",
						"ssh": {
							"publicKeys": [{
								"path": "[variables('sshKeyPath')]",
								"keyData": "[parameters('sshKeyData')]"
							}]
						}
					}
				},
				"storageProfile": {
					"imageReference": {
						"publisher": "[parameters('imagePublisher')]",
						"offer": "[parameters('imageOffer')]",
						"sku": "[parameters('imageSku')]",
						"version": "latest"
					},
					"osDisk": {
						"name": "osdisk",
						"vhd": {
							"uri": "[concat('http://',variables('storageAccountName'),'.blob.core.windows.net/',variables('vmStorageAccountContainerName'),'/', variables('osDiskName'),'.vhd')]"
						},
						"caching": "ReadWrite",
						"createOption": "FromImage"
					}
				},
				"networkProfile": {
					"networkInterfaces": [{
						"id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
					}]
				},
				"diagnosticsProfile": {
					"bootDiagnostics": {
						"enabled": "true",
						"storageUri": "[concat('http://',variables('storageAccountName'),'.blob.core.windows.net')]"
					}
				}
			}
		}
	]